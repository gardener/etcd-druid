---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: etcd-druid
  namespace: {{ .Release.Namespace }}
  labels:
    gardener.cloud/role: etcd-druid
spec:
  replicas: {{ .Values.replicas }}
  selector:
    matchLabels:
      gardener.cloud/role: etcd-druid
  template:
    metadata:
      labels:
        gardener.cloud/role: etcd-druid
    spec:
      serviceAccountName: etcd-druid
      containers:
      - name: etcd-druid
        image: {{ .Values.image.repository }}:{{ .Values.image.tag }}
        imagePullPolicy: {{ .Values.image.imagePullPolicy }}
        command:
        - /etcd-druid
        - --enable-leader-election=true
        - --ignore-operation-annotation={{ .Values.ignoreOperationAnnotation }}
        - --etcd-workers=3
        {{- if .Values.enableBackupCompaction }}
        - --enable-backup-compaction={{ .Values.enableBackupCompaction }}
        {{- end }}
        {{- if .Values.eventsThreshold }}
        - --etcd-events-threshold={{ .Values.eventsThreshold }}
        {{- end }}
        {{- if .Values.metricsScrapeWaitDuration }}
        - --metrics-scrape-wait-duration={{ .Values.metricsScrapeWaitDuration }}
        {{- end }}

        {{- if .Values.featureGates }}
        {{- $featuregates := "" }}
        {{- range $feature, $value := $.Values.featureGates }}
        {{- $featuregates = printf "%s%s=%t," $featuregates $feature $value }}
        {{- end }}
        - --feature-gates={{ $featuregates | trimSuffix "," }}
        {{- end }}

        {{- if (((.Values.server).webhook).bindAddress) }}
        - --webhook-server-bind-address={{ .Values.server.webhook.bindAddress }}
        {{- end }}
        {{- if (((.Values.server).webhook).port) }}
        - --webhook-server-port={{ .Values.server.webhook.port }}
        {{- end }}
        {{- if ((((.Values.server).webhook).tls).serverCertDir) }}
        - --webhook-server-tls-server-cert-dir={{ .Values.server.webhook.tls.serverCertDir }}
        {{- end }}

        {{- if .Values.enableSentinelWebhook }}
        - --enable-sentinel-webhook={{ .Values.enableSentinelWebhook }}
        - --reconciler-service-account=system:serviceaccount:{{ .Release.Namespace }}:etcd-druid
        {{- end }}

        resources:
          limits:
            cpu: 300m
            memory: 512Mi
          requests:
            cpu: 50m
            memory: 128Mi
        ports:
        - containerPort: 9569
        volumeMounts:
          - mountPath: /etc/webhook-server-tls
            name: tls
            readOnly: true
      volumes:
        - name: tls
          secret:
            defaultMode: 420
            secretName: etcd-druid-server-tls
